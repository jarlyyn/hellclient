<html>
    <head>
        <title>Hellclient</title>
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <style>

            body{background: black;color:white;font-family: monospace;margin:0;padding:0}
            ul,li{padding:0;margin:0;list-style: none}
            ul#lines{white-space: pre}
            ul#lines li{max-width: 80em;overflow: hidden;}
            .words .Black{color:rgb(0,0,0)}
            .words .Red{color:rgb(127,0,0)}
            .words .Green{color:rgb(0,147,0)}
            .words .Yellow{color:rgb(252,127,0)}
            .words .Blue{color:rgb(0,0,127)}
            .words .Magenta{color:rgb(156,0,156)}
            .words .Cyan{color:rgb(0,147,147)}
            .words .White{color:rgb(210,210,210)}
            .words .Bright-Black{color:rgb(127,127,127)}
            .words .Bright-Red{color:rgb(255,0,0)}
            .words .Bright-Green{color:rgb(0,252,0)}
            .words .Bright-Yellow{color:rgb(255,255,0)}
            .words .Bright-Blue{color:rgb(0,0,252)}
            .words .Bright-Magenta{color:rgb(255,0,255)}
            .words .Bright-Cyan{color:rgb(0,255,255)}
            .words .Bright-White{color:rgb(255,255,255)}
            .words .BG-Black{background:rgb(0,0,0)}
            .words .BG-Red{background:rgb(127,0,0)}
            .words .BG-Green{background:rgb(0,147,0)}
            .words .BG-Yellow{background:rgb(252,127,0)}
            .words .BG-Blue{background:rgb(0,0,127)}
            .words .BG-Magenta{background:rgb(156,0,156)}
            .words .BG-Cyan{background:rgb(0,147,147)}
            .words .BG-White{background:rgb(210,210,210)}
            .words .BG-Bright-Black{background:rgb(127,127,127)}
            .words .BG-Bright-Red{background:rgb(255,0,0)}
            .words .BG-Bright-Green{background:rgb(0,252,0)}
            .words .BG-Bright-Yellow{background:rgb(255,255,0)}
            .words .BG-Bright-Blue{background:rgb(0,0,252)}
            .words .BG-Bright-Magenta{background:rgb(255,0,255)}
            .words .BG-Bright-Cyan{background:rgb(0,255,255)}
            .words .BG-Bright-White{background:rgb(255,255,255)}
            .words.print{color: red;}
            .words .bold{font-weight: bold}
            ul#lines{padding-bottom: 40px;margin-bottom:-32px;padding-top: 90px;margin-top:-80px}
            #footer{position: fixed;bottom:0;height: 32px;left:0;width:100%;background:black}
            #user-input{height: 32px;padding-left: 8em;padding-right:8em;position: relative;}
            #user-input .el-input-group__prepend{background: black}
            #user-input span{height:32px;line-height:32px}
            #user-input .el-input__inner{background: black;color:white;border-bottom: none}
            #top{position: fixed;top:0;left:0;width: 100%;height:80px;background: white}
            #top .el-tabs__header{margin:0}
            #buttons{padding:4px}
            .el-tooltip__popper{color:black}
            #current{z-index: 1;position:relative;font-weight:  bold;line-height: 32px;float: left;width:7em;margin-right:-8em;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;text-align:left;text-decoration: underline;padding: 0 0.5em 0 0.5em;background: black}
            #current:hover{width: 100%;margin-right: -100%}
            #main-button{padding-right: 2em}
        </style>
    </head>
    <body>
        <div id="app">
            <div id="top">
                <el-tabs v-model="current" type="card" :before-leave="onChange">
                        <el-tab-pane  v-for="client in clients" :label="running[client.ID]? '‚ñ∂Ô∏è '+client.ID:'‚è∏Ô∏è '+client.ID" :name="client.ID"></el-tab-pane>
                      </el-tabs>
            <div id="buttons">
                    <el-button-group id="main-button">
                    <el-tooltip class="item" effect="light" content="Ê∑ªÂä†Ê∏∏Êàè" placement="bottom">
                    <el-button size="mini" type="primary" icon="el-icon-plus"></el-button>
                    </el-tooltip>
                    </el-button-group >
                    <el-button-group v-if="current">
                                <el-tooltip v-if="!running[current]" class="item" effect="light" content="ËøûÁ∫ø"  placement="bottom">
                                    <el-button  @click="onButton('connect')" size="mini" type="success" icon="el-icon-arrow-right"></el-button>
                                    </el-tooltip>
                                    <el-tooltip v-if="running[current]" class="item" effect="light" content="Êñ≠Á∫ø"  placement="bottom">
                                    <el-button  @click="onButton('disconnect')" size="mini" type="danger" icon="el-icon-close"></el-button>
                                    </el-tooltip>                            
                    </el-button-group>
            </div>
            </div>
        <ul id="lines">
            <li v-bind:class="'words '+ (line.IsPrint?' print':'')" v-for="line in lines">
                <span v-if="line.IsPrint">üó®Ô∏è</span>
                <span v-bind:class="word.Color + ' ' +word.Background + (word.Bold?' bold':'') " v-for="word in line.Words" >{{word.Text}}</span>
            </li>
        </ul>
        <div id="footer">
                <div id="current">
                    {{current}}
                </div>
        <div  id="user-input" v-on:keyup.13="send">
        <el-input size="small" placeholder="ËØ∑ËæìÂÖ•ÂëΩ‰ª§" v-model="cmd" >
                <template  v-if="prompt &&  prompt.Words.length" slot="prepend">          <div class="words">      <span v-bind:class="word.Color + ' ' +word.Background + (word.Bold?' bold':'') + (word.IsPrint?' print':'')" v-for="word in prompt.Words" >{{word.Text}}</span></div>
                </template>
              </el-input>            
            </div>
    </div>
</div>
    </body>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
     var   body=document.getElementsByTagName("body")[0]
    </script>
    <script>
        var handlers={}
        var onButton={}
        var current=""
        var ws=new WebSocket("ws:"+location.host+"/ws");
        
        var convertmsg=function(data){
            var sep=data.indexOf(" ")
            var msg
            if (sep>0){
                msg={
                    type:data.substr(0,sep),
                }
                var msgdata =data.substr(sep+1)
                if (msgdata){
                msg.data=JSON.parse(msgdata)
                }
            }else{
                msg={
                    type:data
                }
            }

            return msg
        }
        ws.onclose=function(){
            vm.$alert('‰Ω†‰∏éÁ®ãÂ∫èË¢´Êñ≠ÂºÄ‰∫ÜÔºåÂèØËÉΩÊòØÈÄöËøáÂà´ÁöÑÈ°µÈù¢ÊâìÂºÄ/Á®ãÂ∫èÂèëÁîüÈîôËØØ/Á®ãÂ∫èÊ≠ªÊú∫ÔºåÈúÄË¶ÅÈáçËøûÊâçËÉΩÁªßÁª≠Êìç‰Ωú', 'ËøûÊé•Êñ≠ÂºÄ', {
          confirmButtonText: 'ÈáçÊñ∞ËøûÊé•',
          showClose:false,
          callback: function(){
            location.reload()
          }
        });
        }
        ws.onmessage = function(event) {
            data=convertmsg(event.data);
            var f=handlers[data.type];
            if (f){
                f(data.data)
            }
        }
        var send=function(cmd,data){
            if (ws.readyState){
                ws.send(cmd+" "+data)
            }
        }
    </script>
    <script>
        onButton.connect=function(){
            send("connect",vm.current)
        }
        onButton.disconnect=function(){
            send("disconnect",vm.current)
        }
    </script>
    <script>
        handlers.current=function(data){
            vm.current=data
        }
        handlers.line=function(data){
            var lines=vm.lines
            lines.push(data)
            if (lines.length>500){
                lines.shift()
            }else{
                setTimeout(function(){
                body.scrollTo(body.offsetLeft,body.offsetHeight)
                },0)
            }
            vm.lines=lines
        }
        handlers.prompt=function(data){
            vm.prompt=data
        }
        handlers.clients=function(data){
            vm.clients=data
            data.forEach(function(client) {
                vm.running[client.ID]=client.Running
            })
        }
        handlers.lines=function(data){
            var lines=[]
            data.forEach(function(element) {
                lines.push(element)
            if (lines.length>500){
                lines.shift()
            }
            })
            vm.lines=lines
            setTimeout(function(){
                body.scrollTo(body.offsetLeft,body.offsetHeight)
                },0)
        }
        handlers.connected=function(data){
            vm.running[data]=true
        }
        handlers.disconnected=function(data){
            vm.running[data]=false
        }
    </script>
    <script>
        var data={
            current:"",
            lines:[],
            prompt:"",
            cmd:"",
            running:{},
            clients:[],
        }
        var vm = new Vue({
            el:"#app",
            data: data,
            methods:{
                send:function(){
                     send("send",this.cmd)
                     document.getElementById("user-input").getElementsByTagName("input")[0].select()
                },
                onChange:function(current){
                    send("change",current)
                },
                onButton:function(data){
                    onButton[data]()
                }
            }
        })

    </script>
</html>