<html>
    <head>
        <title>Hellclient</title>
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <style>

            body{background: black;color:white;font-family: monospace;margin:0;padding:0}
            ul,li{padding:0;margin:0;list-style: none}
            ul#lines{white-space: pre}
            ul#lines li{max-width: 80em;overflow: hidden;}
            .words .Black{color:rgb(0,0,0)}
            .words .Red{color:rgb(127,0,0)}
            .words .Green{color:rgb(0,147,0)}
            .words .Yellow{color:rgb(252,127,0)}
            .words .Blue{color:rgb(0,0,127)}
            .words .Magenta{color:rgb(156,0,156)}
            .words .Cyan{color:rgb(0,147,147)}
            .words .White{color:rgb(210,210,210)}
            .words .Bright-Black{color:rgb(127,127,127)}
            .words .Bright-Red{color:rgb(255,0,0)}
            .words .Bright-Green{color:rgb(0,252,0)}
            .words .Bright-Yellow{color:rgb(255,255,0)}
            .words .Bright-Blue{color:rgb(0,0,252)}
            .words .Bright-Magenta{color:rgb(255,0,255)}
            .words .Bright-Cyan{color:rgb(0,255,255)}
            .words .Bright-White{color:rgb(255,255,255)}
            .words .BG-Black{background:rgb(0,0,0)}
            .words .BG-Red{background:rgb(127,0,0)}
            .words .BG-Green{background:rgb(0,147,0)}
            .words .BG-Yellow{background:rgb(252,127,0)}
            .words .BG-Blue{background:rgb(0,0,127)}
            .words .BG-Magenta{background:rgb(156,0,156)}
            .words .BG-Cyan{background:rgb(0,147,147)}
            .words .BG-White{background:rgb(210,210,210)}
            .words .BG-Bright-Black{background:rgb(127,127,127)}
            .words .BG-Bright-Red{background:rgb(255,0,0)}
            .words .BG-Bright-Green{background:rgb(0,252,0)}
            .words .BG-Bright-Yellow{background:rgb(255,255,0)}
            .words .BG-Bright-Blue{background:rgb(0,0,252)}
            .words .BG-Bright-Magenta{background:rgb(255,0,255)}
            .words .BG-Bright-Cyan{background:rgb(0,255,255)}
            .words .BG-Bright-White{background:rgb(255,255,255)}
            .words.system{color: red;}
            .words .bold{font-weight: bold}
            ul#lines{padding-bottom: 40px;margin-bottom:-32px;padding-top: 90px}
            #footer{position: fixed;bottom:0;height: 32px;left:0;width:100%;background:black}
            #user-input{height: 32px;padding-left: 8em;padding-right:8em;position: relative;}
            #user-input .el-input-group__prepend{background: black}
            #user-input span{height:32px;line-height:32px}
            #user-input .el-input__inner{background: black;color:white;border-bottom: none}
            #top{position: fixed;top:0;left:0;width: 100%;height:80px;background: white}
            #top .el-tabs__header{margin:0}
            #buttons{padding:4px}
            .el-tooltip__popper{color:black}
            #current{z-index: 1;position:relative;font-weight:  bold;line-height: 32px;float: left;width:7em;margin-right:-8em;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;text-align:left;text-decoration: underline;padding: 0 0.5em 0 0.5em;background: black}
            #current:hover{width: 100%;margin-right: -100%}
            #main-button{padding-right: 2em}
            #tabs{height:43px}
            #no-clients{color:black;font-weight: bold;line-height:43px;text-indent: 0.5em}
            #triggers .el-table .cell{color:#333333}
            .el-form .el-switch{height:40px;line-height: 40px}
        </style>
    </head>
    <body>
        <div id="app">
            <div id="top">
                <div id="tabs">
                    <div id="no-clients" v-if="!clients.length">ËøòÊú™ÂàõÂª∫Ê∏∏ÊàèÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂàõÂª∫Êñ∞Ê∏∏Êàè</div>
                <el-tabs v-if="clients.length" v-model="currenttab" type="card" @tab-click="onChange">
                        <el-tab-pane  v-for="client in clients" :label="running[client.ID]? '‚ñ∂Ô∏è '+client.ID:'‚è∏Ô∏è '+client.ID" :name="client.ID"></el-tab-pane>
                      </el-tabs>
                    </div>
            <div id="buttons">
                    <el-button-group id="main-button">
                    <el-tooltip class="item" effect="light" content="Ê∑ªÂä†Ê∏∏Êàè" placement="bottom">
                    <el-button @click="onButton('createGame')" size="mini" type="primary" icon="el-icon-plus"></el-button>
                    </el-tooltip>
                    </el-button-group >
                    <span  v-if="current">
                    <el-button-group>
                                <el-tooltip v-if="!running[current]" class="item" effect="light" content="ËøûÁ∫ø"  placement="bottom">
                                    <el-button  @click="onButton('connect')" size="mini" type="success" icon="el-icon-arrow-right"></el-button>
                                    </el-tooltip>
                                    <el-tooltip v-if="running[current]" class="item" effect="light" content="Êñ≠Á∫ø"  placement="bottom">
                                    <el-button  @click="onButton('disconnect')" size="mini" type="danger" icon="el-icon-close"></el-button>
                                    </el-tooltip>
                                    <el-tooltip class="item" effect="light" content="ÂéÜÂè≤ËæìÂá∫"  placement="bottom">
                                            <el-button  @click="onButton('options')" size="mini" icon="el-icon-view"></el-button>
                                            </el-tooltip>
                                    <el-tooltip class="item" effect="light" content="ËÆæÁΩÆ"  placement="bottom">
                                            <el-button  @click="onButton('options')" size="mini" icon="el-icon-edit"></el-button>
                                            </el-tooltip>
                                                    
                    </el-button-group>
                    <el-button-group>
                            <el-tooltip class="item" effect="light" content="ËÑöÊú¨"  placement="bottom">
                                    <el-button  @click="onButton('script')" size="mini" icon=" el-icon-setting"></el-button>
                                    </el-tooltip>
                                    <el-tooltip class="item" effect="light" content="ÂèòÈáè"  placement="bottom">
                                        <el-button  @click="onButton('variable')" size="mini" >?</el-button>
                                        </el-tooltip>
                        <el-tooltip class="item" effect="light" content="Ëß¶ÂèëÂô®"  placement="bottom">
                            <el-button  @click="onButton('triggers')" size="mini" icon=" el-icon-tickets"></el-button>
                            </el-tooltip>
                            <el-tooltip class="item" effect="light" content="ËÆ°Êó∂Âô®"  placement="bottom">
                                <el-button  @click="onButton('timers')" size="mini" icon="el-icon-time"></el-button>
                                </el-tooltip>
                                <el-tooltip class="item" effect="light" content="Âà´Âêç"  placement="bottom">
                                    <el-button  @click="onButton('alias')" size="mini" >=</el-button>
                                    </el-tooltip>
                    </el-button-group>
                </span>
            </div>
            </div>
        <ul id="lines">
            <li v-bind:class="'words '+ (line.IsPrint?' print':'') + (line.IsSystem?' system':'')" v-for="line in lines">
                <span v-if="line.IsSystem">üó®Ô∏è</span>
                <span v-bind:class="word.Color + ' ' +word.Background + (word.Bold?' bold':'') " v-for="word in line.Words" >{{word.Text}}</span>
            </li>
        </ul>
        <el-dialog width="80%"  :fullscreen="true"  title=" Ëß¶ÂèëÂô®" :visible.sync="triggersVisible">
            <div id="triggers" v-if="triggers!==null">
                    <el-button-group >
                            <el-tooltip class="item" effect="light" content="Ê∑ªÂä†" placement="bottom">
                            <el-button @click="onButton('createTrigger')" size="mini" type="primary" icon="el-icon-plus"></el-button>
                            </el-tooltip>
                        </el-button-group >
                <el-table
                :data="triggers"
                style="width: 100%">
                <el-table-column
                  prop="Pattern"
                  label="ÂåπÈÖçÈ°π"
                  >
                </el-table-column>
                <el-table-column
                  prop="Enabled"
                  label="ÊúâÊïà"
                  width="60"
                  >
                  <template slot-scope="scope">
                      <span>{{scope.row.Enabled ? "ÊòØ":"Âê¶"}}</span>
                 </template>
                </el-table-column>
                <el-table-column
                  prop="IsRegExp"
                  label="Ê≠£Âàô"
                  width="60"
                  >
                  <template slot-scope="scope">
                        <span>{{scope.row.IsRegExp ? "ÊòØ":"Âê¶"}}</span>
                   </template>
                </el-table-column>
                <el-table-column
                  prop="Command"
                  label="ÂëΩ‰ª§"
                  >
                </el-table-column>
                  <el-table-column
                  prop="Finally"
                  label="ÂÅúÊ≠¢"
                  width="60"
                  >
                  <template slot-scope="scope">
                        <span>{{scope.row.Finally ? "ÊòØ":"Âê¶"}}</span>
                   </template>
                </el-table-column>
                <el-table-column
                prop="Priority"
                label="‰ºòÂÖàÁ∫ß"
                width="60"
                >
            </el-table-column>
            <el-table-column
            fixed="right"
            label="Êìç‰Ωú"
            width="100">
            <template slot-scope="scope">
              <el-button @click="onUpdateTrigger(scope.row)" type="text" size="small">ÁºñËæë</el-button>
              <el-button type="text" size="small">Âà†Èô§</el-button>
            </template>
          </el-table-column>
      
              </el-table>
                  <el-dialog
    
      title="ÁºñËæëËß¶ÂèëÂô®"
      :visible.sync="triggerSaveFormVisible"
      append-to-body>
      <div v-if="saveTriggerFail">
        <el-alert v-for="err in saveTriggerFail" :title="err.Msg" type="error" show-icon> </el-alert>
    
</div>
    <el-form :model="triggerSaveForm">
           
      <el-form-item label="ÂåπÈÖçÈ°π" label-width="80">
        <el-input v-model="triggerSaveForm.Pattern" autocomplete="off"></el-input>
      </el-form-item>
      <el-form-item label="ÊúâÊïà" label-width="80">
            <el-switch  v-model="triggerSaveForm.Enabled" active-color="#13ce66" inactive-color="#ff4949"> </el-switch>
        </el-form-item>
        <el-form-item label="Ê≠£Âàô" label-width="80">
                <el-switch  v-model="triggerSaveForm.IsRegExp" active-color="#13ce66" inactive-color="#ff4949"> </el-switch>
            </el-form-item>
            <el-form-item label="ÂëΩ‰ª§" label-width="80">
                    <el-input v-model="triggerSaveForm.Command" autocomplete="off"></el-input>
                  </el-form-item>            
                  <el-form-item label="ÂÅúÊ≠¢" label-width="80">
                        <el-switch  v-model="triggerSaveForm.Finally" active-color="#13ce66" inactive-color="#ff4949"> </el-switch>
                      </el-form-item>           
                      <el-form-item label="‰ºòÂÖàÁ∫ß" label-width="80">
                            <el-input v-model="triggerSaveForm.Priority" autocomplete="off"></el-input>
                          </el-form-item>                       
                                      
    </el-form>
    <div slot="footer" class="dialog-footer">
      <el-button @click="triggerSaveFormVisible = false">Âèñ Ê∂à</el-button>
      <el-button type="primary" @click="onButton('saveTriggerSubmit')">Á°Æ ÂÆö</el-button>
    </div>

    </el-dialog>

            </div>
                <div slot="footer" class="dialog-footer">
                  <el-button @click="triggersVisible = false">Âèñ Ê∂à</el-button>
                </div>
              </el-dialog>
        <el-dialog title="ÂàõÂª∫Ê∏∏Êàè" :visible.sync="gameCreateFormVisible">
            <div v-if="createFail">
                    <el-alert v-for="err in createFail" :title="err.Msg" type="error" show-icon> </el-alert>
                
            </div>
                <el-form :model="gameCreateForm">
                        <el-form-item label="ÂêçÁß∞" label-width="80">
                                <el-input v-model="gameCreateForm.ID" autocomplete="off"></el-input>
                        </el-form-item>                    
                  <el-form-item label="ÁΩëÂùÄ" label-width="80">
                    <el-input v-model="gameCreateForm.Host" autocomplete="off"></el-input>
                  </el-form-item>
                  <el-form-item label="Á´ØÂè£" label-width="80">
                        <el-input v-model="gameCreateForm.Port" autocomplete="off"></el-input>
                      </el-form-item>
                  <el-form-item label="Â≠óÁ¨¶ÁºñÁ†Å" label-width="80">
                    <el-select v-model="gameCreateForm.Charset" placeholder="ËØ∑ÈÄâÂ≠óÁ¨¶ÁºñÁ†Å">
                      <el-option label="GBK" value="gbk"></el-option>
                      <el-option label="UTF8" value="utf8"></el-option>
                    </el-select>
                  </el-form-item>
                </el-form>
                <div slot="footer" class="dialog-footer">
                  <el-button @click="gameCreateFormVisible = false">Âèñ Ê∂à</el-button>
                  <el-button type="primary" @click="onButton('createGameSubmit')">Á°Æ ÂÆö</el-button>
                </div>
              </el-dialog>              
        <div id="footer">
                <div id="current">
                    {{current}}
                </div>
        <div  id="user-input" v-on:keyup.13="send">
        <el-input size="small" placeholder="ËØ∑ËæìÂÖ•ÂëΩ‰ª§" v-model="cmd" >
                <template  v-if="prompt &&  prompt.Words &&  prompt.Words.length" slot="prepend">          <div class="words">      <span v-bind:class="word.Color + ' ' +word.Background + (word.Bold?' bold':'') + (word.IsPrint?' print':'')" v-for="word in prompt.Words" >{{word.Text}}</span></div>
                </template>
              </el-input>            
            </div>
    </div>
</div>


    </body>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
     var   body=document.getElementsByTagName("body")[0]
    </script>
    <script>
        var handlers={}
        var onButton={}
        var current=""
        var ws=new WebSocket("ws:"+location.host+"/ws");
        
        var convertmsg=function(data){
            var sep=data.indexOf(" ")
            var msg
            if (sep>0){
                msg={
                    type:data.substr(0,sep),
                }
                var msgdata =data.substr(sep+1)
                if (msgdata){
                msg.data=JSON.parse(msgdata)
                }
            }else{
                msg={
                    type:data
                }
            }

            return msg
        }
        ws.onclose=function(){
            vm.$alert('‰Ω†‰∏éÁ®ãÂ∫èË¢´Êñ≠ÂºÄ‰∫ÜÔºåÂèØËÉΩÊòØÈÄöËøáÂà´ÁöÑÈ°µÈù¢ÊâìÂºÄ/Á®ãÂ∫èÂèëÁîüÈîôËØØ/Á®ãÂ∫èÊ≠ªÊú∫ÔºåÈúÄË¶ÅÈáçËøûÊâçËÉΩÁªßÁª≠Êìç‰Ωú', 'ËøûÊé•Êñ≠ÂºÄ', {
          confirmButtonText: 'ÈáçÊñ∞ËøûÊé•',
          showClose:false,
          callback: function(){
            location.reload()
          }
        });
        }
        ws.onmessage = function(event) {
            data=convertmsg(event.data);
            var f=handlers[data.type];
            if (f){
                f(data.data)
            }
        }
        var send=function(cmd,data){
            if (ws.readyState){
                var msg=JSON.stringify(data)
                console.log(msg)
                ws.send(cmd+" "+JSON.stringify(data))
            }
        }
    </script>
    <script>
        onButton.connect=function(){
            send("connect",vm.current)
        }
        onButton.disconnect=function(){
            send("disconnect",vm.current)
        }
        onButton.createGame=function(){
            vm.createFail=[];
            vm.gameCreateForm={};
            vm.gameCreateFormVisible=true;
        }
        onButton.createGameSubmit=function(){
            send("createGame",vm.gameCreateForm)
        }
        onButton.triggers=function(){
            vm.triggers=null;
            vm.triggersVisible=true
            send("triggers",current)
        }
        onButton.createTrigger=function(){
            vm.triggerSaveFormVisible=true
            vm.triggerName=""
            vm.triggerSaveForm={}
        }
        onButton.saveTriggerSubmit=function(){
            vm.triggerSaveForm.Name=vm.triggerName
            vm.triggerSaveForm.Priority=vm.triggerSaveForm.Priority*1;
            send("saveTrigger",vm.triggerSaveForm)
        }
    </script>
    <script>
        handlers.current=function(data){
            vm.current=data
            vm.currenttab=data
        }
        handlers.line=function(data){
            var lines=vm.lines
            lines.push(data)
            if (lines.length>500){
                lines.shift()
            }else{
                setTimeout(function(){
                body.scrollTo(body.offsetLeft,body.offsetHeight)
                },0)
            }
            vm.lines=lines
        }
        handlers.prompt=function(data){
            vm.prompt=data
        }
        handlers.clients=function(data){
            vm.clients=data
            data.forEach(function(client) {
                vm.running[client.ID]=client.Running
            })
        }
        handlers.lines=function(data){
            var lines=[]
            data.forEach(function(element) {
                lines.push(element)
            if (lines.length>500){
                lines.shift()
            }
            })
            vm.lines=lines
            setTimeout(function(){
                body.scrollTo(body.offsetLeft,body.offsetHeight)
                },0)
        }
        handlers.connected=function(data){
            vm.running[data]=true
        }
        handlers.disconnected=function(data){
            vm.running[data]=false
        }
        handlers.createFail=function(data){
            vm.createFail=data
        }
        handlers.createSuccess=function(data){
            vm.gameCreateFormVisible=false;
            send("change",data)
        }
        handlers.triggers=function(data){
            vm.triggers=data
        }
        handlers.triggerFail=function(data){
            vm.saveTriggerFail=data
        }
        handlers.triggerSuccess=function(data){
            vm.triggerSaveFormVisible=false;
        }
        
    </script>
    <script>
        var data={
            current:"",
            currenttab:"",
            lines:[],
            prompt:{},
            createFail:[],
            cmd:"",
            running:{},
            clients:[],
            gameCreateFormVisible:false,
            gameCreateForm:{},
            triggers:null,
            triggerName:"",
            triggersVisible:false,
            triggerSaveFormVisible:false,
            triggerSaveForm:{},
            saveTriggerFail:[],
        }
        var vm = new Vue({
            el:"#app",
            data: data,
            methods:{
                send:function(){
                     send("send",this.cmd)
                     document.getElementById("user-input").getElementsByTagName("input")[0].select()
                },
                onChange:function(current){
                    if (vm.clients.length){
                    send("change",current.name)
                    }
                    return false
                },
                onButton:function(data){
                    onButton[data]()
                },
                onUpdateTrigger:function(data){
                    vm.saveTriggerFail=[];
                    vm.triggerName=data.Name;
                    vm.triggerSaveForm=data;
                    vm.triggerSaveFormVisible=true;
                    vm.triggersVisible=true;
                }
            }
        })

    </script>
</html>